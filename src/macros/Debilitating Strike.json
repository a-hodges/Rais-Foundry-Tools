{
  "name": "Debilitating Strike",
  "type": "script",
  "_id": "VASs6406xX5WR4jW",
  "author": "UFqVA7oOCQDF3osw",
  "img": "icons/skills/melee/strike-sword-blood-red.webp",
  "scope": "global",
  "command": "const actor = canvas.tokens.controlled[0].actor;\nconst targets = game.user.targets;\nconst predicates = Object.keys(actor.rollOptions.all);\n\nconst debil_feature = actor.items.getName(\"Debilitating Strike\");\nif (debil_feature === undefined) {\n  Dialog.prompt({\n    title: \"Invalid Action\",\n    content: \"Actor does not have the Debilitating Strike feature.\",\n  });\n}\n\nconst debil = debil_feature.rules.find(rule => rule.key === \"RollOption\" && rule.label === \"Debilitation\");\n\nconst options = debil.suboptions.filter(opt => game.pf2e.Predicate.test(opt.predicate, predicates));\nconst buttons = await Promise.all(options.map(async opt => ({label: (await game.pf2e.TextEditor.enrichHTML(`@Localize[${opt.label}]`)) + (opt.selected ? \"*\" : \"\"), callback: () => opt.value})));\n\nconst selection = await Dialog.wait({\n  title: \"Select Debilitation\",\n  content: \"Which debilitation are you applying?\",\n  buttons: buttons\n});\n\nawait debil.toggle(selection, selection);\n\n/*\nlet enduring = false;\nif (game.pf2e.Predicate.test([\"feat:enduring-debilitation\"], predicates)) {\n  enduring = await Dialog.confirm({\n    title: \"Enduring Debilitation\",\n    content: \"Are you using Endurting Debilitation?\"\n  });\n}\nconst effect = (await fromUuid(enduring ? \"Compendium.pf2e.feat-effects.Item.PX6WdrpzEdUzKRHx\" : \"Compendium.pf2e.feat-effects.Item.yBTASi3FvnReAwHy\")).clone();\n*/\n\nif (selection === \"bloody\") {\n  const DamageRoll = CONFIG.Dice.rolls.find((r) => r.name === \"DamageRoll\");\n  const r = await new DamageRoll(\"3d6[bleed]\").evaluate();\n  await r.toMessage();\n} else if (selection === \"critical\") {\n  const dc = actor.classDC.dc.value;\n  for (const target of targets) {\n    const save = await target.actor.saves.fortitude.roll({dc});\n    const effect = await fromUuid({\n      0: \"Compendium.rais-tools.items.Item.nI2ckmZD4slpH4w6\",\n      1: \"Compendium.rais-tools.items.Item.K0p1XUBwZUhIr1FG\",\n      2: \"Compendium.rais-tools.items.Item.TCyuF4bRQyjt5cYi\"\n    }[save.degreeOfSuccess]);\n    if (effect !== null) {\n      await target.actor.addToInventory(effect);\n    }\n  }\n} else if (selection === \"precision-damage\") {\n  ;\n} else if (selection === \"weakness\") {\n  const damage_type = await Dialog.wait({\n    title: \"Select Damage Type\",\n    content: \"Apply weakness 5 to the selected damage type.\",\n    buttons: [\n      {label: \"bludgeoning\", callback: () => \"b\"},\n      {label: \"piercing\", callback: () => \"p\"},\n      {label: \"slashing\", callback: () => \"s\"}\n    ]\n  });\n  const effect = await fromUuid({\n    \"b\": \"Compendium.rais-tools.items.Item.7enhugMtLIXsJETm\",\n    \"p\": \"Compendium.rais-tools.items.Item.R8bU2yVflhabDDij\",\n    \"s\": \"Compendium.rais-tools.items.Item.bJZTOPlBmz24Vkoc\",\n  }[selection]);\n  for (const target of targets) {\n    await target.actor.addToInventory(effect);\n  }\n} else {\n  const effect = await fromUuid({\n    \"clumsy\": \"Compendium.rais-tools.items.Item.MAleBa1gZ8L8Yiyz\",\n    \"enfeebled\": \"Compendium.rais-tools.items.Item.bzhoEn7NXbt0cAt0\",\n    \"off-guard\": \"Compendium.rais-tools.items.Item.lPC1YRkVIveNbP1M\",\n    \"prevent-flanking\": \"Compendium.rais-tools.items.Item.KjjhbZQFNC0tdbPa\",\n    \"prevent-reactions\": \"Compendium.rais-tools.items.Item.ju92Cdq25ndSDD6m\",\n    \"prevent-step\": \"Compendium.rais-tools.items.Item.0vPlYSQumRUlz67H\",\n    \"reduce-cover\": \"Compendium.rais-tools.items.Item.mDfcEAdP2hAgo25H\",\n    \"speed-penalty\": \"Compendium.rais-tools.items.Item.czL2fSW3isNtVmz8\",\n    \"stupefied\": \"Compendium.rais-tools.items.Item.s5oEnXUYn49wT3wj\"\n  }[selection]);\n  for (const target of targets) {\n    await target.actor.addToInventory(effect);\n  }\n}",
  "sort": 0,
  "_key": "!macros!VASs6406xX5WR4jW"
}
